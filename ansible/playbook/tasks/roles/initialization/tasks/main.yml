    ---
    # This role contains tasks executed during initialization PMM Server
    - name: Get current version
      slurp:
        src: /srv/grafana/PERCONA_DASHBOARDS_VERSION
      register: current_version_file

    - name: Get image version
      slurp:
        src: /usr/share/percona-dashboards/VERSION
      register: image_version_file

    - name: Setting current and image version
      set_fact:
        pmm_current_version: "{{ current_version_file['content'] | b64decode | trim }}"
        pmm_image_version: "{{ image_version_file['content'] | b64decode | trim }}"

    - name: Print current version
      debug:
        msg: "Current version: {{ pmm_current_version }} Image Version: {{ pmm_image_version }}"

    - name: Checking if we need an update or not
      meta: end_play
      when: pmm_current_version is version(pmm_image_version, '>=')

    - name: Synchronization plugin
      synchronize:
        src: /usr/share/percona-dashboards/panels/
        dest: /srv/grafana/plugins/
      delegate_to: "{{ inventory_hostname }}"

    - name: Copy file with image version
      copy:
        src: /usr/share/percona-dashboards/VERSION
        dest: /srv/grafana/PERCONA_DASHBOARDS_VERSION
        remote_src: yes
